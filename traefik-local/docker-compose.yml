services:

  # -------------------- Services Python --------------------
  users_service:
    build: ./users_service
    restart: unless-stopped
    command: sh -c "python3 ./server.py"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.users.rule=Host(`users.diplomania2.fr`)"
      - "traefik.http.routers.users.entrypoints=websecure"
      - "traefik.http.routers.users.tls=true"
      - "traefik.http.routers.users.tls.certresolver=myle"
      - "traefik.http.routers.users.middlewares=redirectSecure@file"
      - "traefik.http.services.users_service.loadbalancer.server.port=5001"
    volumes:
      - "./users_service/db:/app/db"
      - "./users_service/logdir:/app/logdir"
    networks:
      - backend

  emails_service:
    build: ./emails_service
    restart: unless-stopped
    command: sh -c "python3 ./server.py"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.emails.rule=Host(`emails.diplomania2.fr`)"
      - "traefik.http.routers.emails.entrypoints=websecure"
      - "traefik.http.routers.emails.tls=true"
      - "traefik.http.routers.emails.tls.certresolver=myle"
      - "traefik.http.routers.emails.middlewares=redirectSecure@file"
      - "traefik.http.services.emails_service.loadbalancer.server.port=5002"
    volumes:
      - "./emails_service/logdir:/app/logdir"
    networks:
      - backend

  players_service:
    build: ./players_service
    restart: unless-stopped
    command: sh -c "python3 ./server.py"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.players.rule=Host(`players.diplomania2.fr`)"
      - "traefik.http.routers.players.entrypoints=websecure"
      - "traefik.http.routers.players.tls=true"
      - "traefik.http.routers.players.tls.certresolver=myle"
      - "traefik.http.routers.players.middlewares=redirectSecure@file"
      - "traefik.http.services.players_service.loadbalancer.server.port=5003"
    volumes:
      - "./players_service/db:/app/db"
      - "./players_service/logdir:/app/logdir"
    networks:
      - backend

  games_service:
    build: ./games_service
    restart: unless-stopped
    command: sh -c "python3 ./server.py"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.games.rule=Host(`games.diplomania2.fr`)"
      - "traefik.http.routers.games.entrypoints=websecure"
      - "traefik.http.routers.games.tls=true"
      - "traefik.http.routers.games.tls.certresolver=myle"
      - "traefik.http.routers.games.middlewares=redirectSecure@file"
      - "traefik.http.services.games_service.loadbalancer.server.port=5004"
    volumes:
      - "./games_service/db:/app/db"
      - "./games_service/logdir:/app/logdir"
    networks:
      - backend

  solver_service:
    build: ./solver_service
    restart: unless-stopped
    command: sh -c "python3 ./server.py"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.solver.rule=Host(`solver.diplomania2.fr`)"
      - "traefik.http.routers.solver.entrypoints=websecure"
      - "traefik.http.routers.solver.tls=true"
      - "traefik.http.routers.solver.tls.certresolver=myle"
      - "traefik.http.routers.solver.middlewares=redirectSecure@file"
      - "traefik.http.services.solver_service.loadbalancer.server.port=5005"
    volumes:
      - "./solver_service/logdir:/app/logdir"
    networks:
      - backend

  scheduler_service:
    build: ./scheduler_service
    restart: unless-stopped
    command: sh -c "sleep 10 && python3 ./server.py"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.scheduler.rule=Host(`scheduler.diplomania2.fr`)"
      - "traefik.http.routers.scheduler.entrypoints=websecure"
      - "traefik.http.routers.scheduler.tls=true"
      - "traefik.http.routers.scheduler.tls.certresolver=myle"
      - "traefik.http.routers.scheduler.middlewares=redirectSecure@file"
      - "traefik.http.services.scheduler_service.loadbalancer.server.port=5006"
    volumes:
      - "./scheduler_service/db:/app/db"
      - "./scheduler_service/logdir:/app/logdir"
    networks:
      - backend

  # -------------------- Traefik --------------------
  traefik:
    image: traefik:latest
    restart: unless-stopped
    command:
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.file.filename=/etc/traefik/dynamic_conf.yml"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.myle.acme.email=jeremie.lefrancois@gmail.com"
      - "--certificatesresolvers.myle.acme.storage=/etc/traefik/acme.json"
      - "--certificatesresolvers.myle.acme.httpchallenge.entrypoint=web"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./traefik/traefik.yml:/etc/traefik/traefik.yml:ro"
      - "./traefik/dynamic_conf.yml:/etc/traefik/dynamic_conf.yml:ro"
      - "./traefik/acme.json:/etc/traefik/acme.json"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.diplomania2.fr`)"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls.certresolver=myle"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.middlewares.auth.basicauth.users=admin:$$apr1$$H3J/gN7n$$B1CJQ9xuWLCUtjrLNg1i11"
      - "traefik.http.routers.traefik.middlewares=auth"
    networks:
      - backend
    depends_on:
      - users_service
      - emails_service
      - players_service
      - games_service
      - solver_service
      - scheduler_service

networks:
  backend:
    driver: bridge
